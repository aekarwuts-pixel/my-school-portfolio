<!DOCTYPE html>
<html lang="th">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QJBKDWWT2P"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-QJBKDWWT2P');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Report</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { background: #525659; font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .paper { background: white; width: 210mm; min-height: 297mm; margin: 20px auto; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative; }
        
        /* Nav Icons */
        .nav-icon { transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .active-nav .nav-icon { transform: translateY(-5px); color: #0071e3; }
        .active-nav span { color: #0071e3; font-weight: 600; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) { 
            .paper { width: 100%; margin: 0; padding: 20px; min-height: 100vh; box-shadow: none; border-radius: 0; margin-bottom: 80px; } 
            body { background: #f5f5f7; } 
        }
        
        /* Print Styles */
        @media print { 
            body { background: white; } 
            .paper { margin: 0; box-shadow: none; width: 100%; padding: 0; } 
            .no-print { display: none !important; } 
        }
        
        .grade-badge { width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 0.85rem; }
        .grade-4 { background: #dcfce7; color: #166534; }
        .grade-3 { background: #dbeafe; color: #1e40af; }
        .grade-2 { background: #fef9c3; color: #854d0e; }
        .grade-1 { background: #fee2e2; color: #991b1b; }
        .grade-0 { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="pb-28 pt-14 md:pt-0">

    <!-- Top Navbar (Mobile only) -->
    <div class="fixed top-0 w-full bg-gray-900 text-white p-3 flex justify-between items-center z-50 no-print md:hidden shadow-md">
        <a href="Classroom_Manager.html" class="text-sm hover:text-gray-300 flex items-center gap-1"><i class="fa-solid fa-chevron-left"></i> กลับ</a>
        <span class="font-bold text-sm">รายงานผลการเรียน</span>
        <div class="w-8"></div>
    </div>

    <!-- Desktop Toolbar -->
    <div class="fixed top-4 right-4 z-50 flex flex-col gap-2 no-print hidden md:flex">
        <button onclick="window.print()" class="bg-white text-gray-800 p-3 rounded-full shadow-lg hover:bg-gray-100 transition tooltip" title="พิมพ์"><i class="fa-solid fa-print"></i></button>
        <a href="Classroom_Manager.html" class="bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition text-center" title="กลับ"><i class="fa-solid fa-arrow-left"></i></a>
    </div>

    <!-- Paper Content -->
    <div class="paper" id="report-content">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start border-b-2 border-gray-800 pb-6 mb-8 gap-4">
            <div class="flex gap-4 items-center">
                <img src="logo-1-1-1.png" class="w-20 h-20 object-contain" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">โรงเรียนเทศบาล ๑ บ้านกลาง</h1>
                    <p class="text-sm text-gray-500">รายงานผลสัมฤทธิ์ทางการเรียนรายบุคคล (Individual Report)</p>
                    <p class="text-sm text-gray-500">ภาคเรียนที่ 1 ปีการศึกษา 2567</p>
                </div>
            </div>
            <div class="text-left md:text-right w-full md:w-auto bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-xl">
                <div class="inline-block bg-gray-200 px-3 py-1 rounded text-sm font-mono text-gray-600 mb-2">ID: <span id="student-id">...</span></div>
                <h2 class="text-xl font-bold text-blue-700" id="student-name">กำลังโหลดข้อมูล...</h2>
                <p class="text-sm text-gray-600" id="student-class">วิชาคอมพิวเตอร์</p>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- Left: Grades Table (2/3 width) -->
            <div class="md:col-span-2 space-y-6">
                <section>
                    <h3 class="font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-book text-gray-400"></i> ผลการเรียนรายวิชา
                    </h3>
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600">
                                <th class="py-2 pl-2 text-left border border-gray-200">รายการประเมิน</th>
                                <th class="py-2 text-center border border-gray-200">คะแนนเต็ม</th>
                                <th class="py-2 text-center border border-gray-200">คะแนนที่ได้</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="grade-table-body">
                            <!-- Data populated by JS -->
                            <tr><td class="py-3 pl-2 border border-gray-200 text-center" colspan="3">กำลังดึงข้อมูล...</td></tr>
                        </tbody>
                        <tfoot class="bg-gray-50 font-bold">
                            <tr>
                                <td class="py-3 pl-2 border border-gray-200 text-right">รวมทั้งสิ้น</td>
                                <td class="py-3 text-center border border-gray-200">100</td>
                                <td class="py-3 text-center border border-gray-200 text-blue-600 text-lg" id="total-score-display">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </section>

                <section class="no-print">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-800 border-l-4 border-purple-500 pl-3 flex items-center justify-between">
                            <span><i class="fa-solid fa-robot text-purple-400 mr-2"></i> ความเห็นครูที่ปรึกษา (AI)</span>
                        </h3>
                        <button onclick="analyzeWithAI()" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-purple-200 transition"><i class="fa-solid fa-wand-magic-sparkles"></i> สร้างความเห็น</button>
                    </div>
                    <div id="ai-analysis-box" class="bg-purple-50 rounded-xl p-5 border border-purple-100 text-sm leading-relaxed text-gray-700 min-h-[80px]">
                        <p class="text-gray-400 italic text-center py-2">กดปุ่ม "สร้างความเห็น" เพื่อให้ AI วิเคราะห์ผลการเรียน</p>
                    </div>
                </section>
                
                <!-- Print only version of comment -->
                <div class="hidden print:block border border-gray-300 p-4 rounded min-h-[100px]">
                    <p class="font-bold mb-2">ความเห็นครูที่ปรึกษา:</p>
                    <p id="print-comment-area" class="leading-loose">..................................................................................................................................................................</p>
                </div>
            </div>

            <!-- Right: Charts & Skills (1/3 width) -->
            <div class="md:col-span-1 space-y-8">
                <div class="bg-white p-2 rounded-xl border border-gray-100 shadow-sm print:shadow-none print:border-none">
                    <h4 class="text-xs font-bold text-center text-gray-400 uppercase mb-2">สมรรถนะผู้เรียน</h4>
                    <canvas id="skillsChart"></canvas>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                    <p class="text-xs text-gray-500 uppercase font-bold">ระดับผลการเรียน</p>
                    <div class="text-5xl font-bold text-blue-600 mt-2" id="gpa-display">-</div>
                    <p class="text-xs text-gray-400 mt-1" id="gpa-text">รอดำเนินการ</p>
                </div>
            </div>
        </div>

        <footer class="mt-12 pt-8 border-t border-gray-200 break-inside-avoid">
            <div class="grid grid-cols-3 gap-8 text-center">
                <div><div class="h-16 border-b border-dotted border-gray-400 mb-2"></div><p class="text-sm font-bold">นายเอกอาวุธ สุริยะเจริญ</p><p class="text-xs text-gray-500">ครูที่ปรึกษา</p></div>
                <div><div class="h-16 border-b border-dotted border-gray-400 mb-2"></div><p class="text-sm font-bold">ผู้ปกครอง</p><p class="text-xs text-gray-500">รับทราบผลการเรียน</p></div>
                <div><div class="h-16 border-b border-dotted border-gray-400 mb-2"></div><p class="text-sm font-bold">ผู้อำนวยการ</p><p class="text-xs text-gray-500">นายทะเบียน</p></div>
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-8">เอกสารฉบับนี้จัดทำโดยระบบสารสนเทศ Digital Teacher Portfolio</p>
        </footer>
    </div>

    <!-- Bottom Nav (Mobile) -->
    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-200 px-4 py-2 md:hidden z-50 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)] no-print pb-safe">
        <div class="relative flex justify-between items-center max-w-sm mx-auto">
            <div id="nav-pill" class="absolute top-1/2 -translate-y-1/2 h-10 w-12 bg-blue-50 rounded-xl transition-all duration-300 ease-out -z-10"></div>
            <a href="Main_Dashboard.html" class="nav-item flex flex-col items-center justify-center w-12 text-gray-400" data-index="0"><i class="fa-solid fa-house text-xl mb-1 nav-icon"></i><span class="text-[9px] font-medium">หน้าหลัก</span></a>
            <a href="LessonPlan_Manager.html" class="nav-item flex flex-col items-center justify-center w-12 text-gray-400" data-index="1"><i class="fa-solid fa-book-open text-xl mb-1 nav-icon"></i><span class="text-[9px] font-medium">แผนการ</span></a>
            <a href="Classroom_Manager.html" class="nav-item flex flex-col items-center justify-center w-12 text-gray-400 active-nav" data-index="2"><i class="fa-solid fa-users text-xl mb-1 nav-icon"></i><span class="text-[9px] font-medium">ชั้นเรียน</span></a>
            <a href="Resource_Library.html" class="nav-item flex flex-col items-center justify-center w-12 text-gray-400" data-index="3"><i class="fa-solid fa-photo-film text-xl mb-1 nav-icon"></i><span class="text-[9px] font-medium">คลังสื่อ</span></a>
            <a href="TeacherPortfolio_BentoGrid.html" class="nav-item flex flex-col items-center justify-center w-12 text-gray-400" data-index="4"><i class="fa-solid fa-user text-xl mb-1 nav-icon"></i><span class="text-[9px] font-medium">ข้อมูล</span></a>
        </div>
    </nav>

    <!-- MODULE SCRIPT: FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBBSbMRUEqxgVCb7CA2G--WjF9OCiAqzJY",
          authDomain: "education-data-management.firebaseapp.com",
          databaseURL: "https://education-data-management-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "education-data-management",
          storageBucket: "education-data-management.firebasestorage.app",
          messagingSenderId: "357308179180",
          appId: "1:357308179180:web:c96102430aa0444c5cfbc9"
        };

        let app, auth, db;
        try {
             app = initializeApp(firebaseConfig);
             auth = getAuth(app);
             db = getFirestore(app);
             signInAnonymously(auth).catch(e => console.warn("Auth failed, using demo"));
        } catch(e) { console.warn("Firebase init failed"); }

        // Get ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        let studentData = {};

        // Helper: Grade Calc
        window.calcGrade = function(score) {
            if(score >= 80) return '4';
            if(score >= 75) return '3.5';
            if(score >= 70) return '3';
            if(score >= 65) return '2.5';
            if(score >= 60) return '2';
            if(score >= 55) return '1.5';
            if(score >= 50) return '1';
            return '0';
        };

        // Fetch Data
        if(docId && db) {
            onAuthStateChanged(auth, (user) => {
                if(user) {
                     // Path must match Classroom_Manager: artifacts/{appId}/public/data/students
                     getDoc(doc(db, 'artifacts', 'education-data-management', 'public', 'data', 'students', docId)).then((docSnap) => {
                        if (docSnap.exists()) {
                            studentData = docSnap.data();
                            renderReport(studentData);
                        } else {
                            document.getElementById('student-name').textContent = "ไม่พบข้อมูล (ID ผิด)";
                            loadDemoData();
                        }
                    }).catch(e => {
                        console.warn("Firebase Error", e);
                        loadDemoData();
                    });
                } else {
                    loadDemoData(); // Fallback
                }
            });
        } else {
            loadDemoData();
        }

        function loadDemoData() {
            studentData = { name: 'ตัวอย่าง (Demo)', studentId: '00000', subject: 'com', s1:20, s2:20, mid:18, fin:25, psy:10 };
            renderReport(studentData);
        }

        function renderReport(data) {
            document.getElementById('student-name').textContent = data.name;
            document.getElementById('student-id').textContent = data.studentId;
            
            let subjectName = "วิชาคอมพิวเตอร์";
            if(data.subject === 'math') subjectName = "วิชาคณิตศาสตร์";
            if(data.subject === 'sci') subjectName = "วิชาวิทยาศาสตร์";
            document.getElementById('student-class').textContent = subjectName;

            // Generate Score Table
            const s1 = parseInt(data.s1)||0;
            const s2 = parseInt(data.s2)||0;
            const mid = parseInt(data.mid)||0;
            const fin = parseInt(data.fin)||0;
            const psy = parseInt(data.psy)||0;
            const total = s1 + s2 + mid + fin + psy;
            const grade = window.calcGrade(total);

            const tbody = document.getElementById('grade-table-body');
            tbody.innerHTML = `
                <tr class="border-b border-gray-100"><td class="py-3 pl-2 border border-gray-200">คะแนนเก็บหน่วยที่ 1</td><td class="py-3 text-center border border-gray-200">20</td><td class="py-3 text-center border border-gray-200">${s1}</td></tr>
                <tr class="border-b border-gray-100"><td class="py-3 pl-2 border border-gray-200">คะแนนเก็บหน่วยที่ 2</td><td class="py-3 text-center border border-gray-200">20</td><td class="py-3 text-center border border-gray-200">${s2}</td></tr>
                <tr class="border-b border-gray-100"><td class="py-3 pl-2 border border-gray-200">สอบกลางภาค</td><td class="py-3 text-center border border-gray-200">20</td><td class="py-3 text-center border border-gray-200">${mid}</td></tr>
                <tr class="border-b border-gray-100"><td class="py-3 pl-2 border border-gray-200">สอบปลายภาค</td><td class="py-3 text-center border border-gray-200">30</td><td class="py-3 text-center border border-gray-200">${fin}</td></tr>
                <tr class="border-b border-gray-100"><td class="py-3 pl-2 border border-gray-200">จิตพิสัย</td><td class="py-3 text-center border border-gray-200">10</td><td class="py-3 text-center border border-gray-200">${psy}</td></tr>
            `;
            
            document.getElementById('total-score-display').textContent = total;
            document.getElementById('gpa-display').textContent = grade;
            document.getElementById('gpa-text').textContent = grade >= 1 ? "ผ่านเกณฑ์การประเมิน" : "ควรปรับปรุง";
            if(grade == '0') document.getElementById('gpa-display').classList.add('text-red-500');

            // Init Chart
            new Chart(document.getElementById('skillsChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['วิชาการ', 'เทคโนโลยี', 'ภาษา', 'วินัย', 'จิตอาสา'],
                    datasets: [{ label: 'สมรรถนะ', data: [total, 90, 70, (data.psy||8)*10, 80], backgroundColor: 'rgba(0, 113, 227, 0.2)', borderColor: '#0071e3' }]
                },
                options: { scales: { r: { ticks: { display: false }, suggestMin: 0, suggestMax: 100 } }, plugins: { legend: { display: false } } }
            });
        }

        // Updated API Key for AI
        const apiKey = "AIzaSyCmcCL6eAc11vaZpsFvYZwqb_zzyVPeK9o";

        // Export function to global
        window.analyzeWithAI = async function() {
            const btn = document.querySelector('button[onclick="analyzeWithAI()"]');
            const box = document.getElementById('ai-analysis-box');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> กำลังวิเคราะห์...';
            
            const total = parseInt(document.getElementById('total-score-display').textContent) || 0;
            const name = document.getElementById('student-name').textContent;
            
            const prompt = `วิเคราะห์ผลการเรียนของนักเรียนชื่อ ${name} คะแนนรวม ${total}/100 วิชาคอมพิวเตอร์ ให้คำแนะนำเชิงบวก สุภาพ และสร้างสรรค์ สำหรับลงในสมุดพก (ภาษาไทย)`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                box.innerHTML = marked.parse(text);
                document.getElementById('print-comment-area').innerHTML = marked.parse(text); // Sync for print
            } catch(e) { box.innerHTML = "AI Error"; }
            
            btn.innerHTML = '<i class="fa-solid fa-robot mr-1"></i> AI วิเคราะห์';
        }

        // Nav Init
        function initNav() {
            const pill = document.getElementById('nav-pill');
            const activeLink = document.querySelector('.active-nav'); 
            const targetLink = document.querySelector('.nav-item[data-index="2"]'); // Highlights Classroom
            if(targetLink && pill) {
                 targetLink.classList.add('active-nav');
                 pill.style.left = targetLink.offsetLeft + 'px';
                 pill.style.width = targetLink.offsetWidth + 'px';
            }
        }
        window.addEventListener('load', initNav); window.addEventListener('resize', initNav);
    </script>
</body>
</html>